<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Браузерный ИИ с обучением</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
<style>
body { font-family: Arial; background: #f0f0f0; }
.container { max-width: 700px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 10px; }
.chat-box { height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fafafa; }
input { width: calc(100% - 110px); padding: 10px; margin-right: 5px; }
button { padding: 10px; width: 100px; margin-bottom: 5px; }
.message { margin-bottom: 10px; }
.user { font-weight: bold; }
.bot { color: #007bff; }
#assistantChat { display: none; border: 1px solid #aaa; padding: 10px; margin-bottom: 10px; background: #fdfdfd; }
</style>
</head>
<body>
<div class="container">
<h1>Браузерный ИИ с помощником</h1>

<button id="trainingToggle">Включить обучение</button>

<h2>Основной чат</h2>
<div class="chat-box" id="chatBox"></div>
<input type="text" id="userInput" placeholder="Введите сообщение..." />
<button id="sendBtn">Отправить</button>

<div id="assistantChat">
<h2>Чат с помощником</h2>
<div class="chat-box" id="assistantBox"></div>
<input type="text" id="assistantInput" placeholder="Введите фразы для обучения..." />
<button id="assistantSend">Добавить в обучение</button>
</div>
</div>

<script>
const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

const assistantChatDiv = document.getElementById("assistantChat");
const assistantBox = document.getElementById("assistantBox");
const assistantInput = document.getElementById("assistantInput");
const assistantSend = document.getElementById("assistantSend");

let trainingEnabled = false;
let trainedPhrases = JSON.parse(localStorage.getItem("trainedPhrases")) || [];
let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

// --- Отображение фраз ---
function renderChatHistory() {
  chatBox.innerHTML = '';
  chatHistory.forEach(msg => addMessage(chatBox, msg.sender, msg.text, msg.className));
}

renderChatHistory();

// --- Переключение обучения ---
document.getElementById("trainingToggle").addEventListener("click", ()=>{
  trainingEnabled = !trainingEnabled;
  assistantChatDiv.style.display = trainingEnabled ? "block" : "none";
});

// --- Основной чат ---
sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });

function sendMessage() {
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(chatBox, "Вы", text, "user");
  chatHistory.push({sender:"Вы", text, className:"user"});
  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
  userInput.value = "";

  const reply = generateResponse(text);
  addMessage(chatBox, "ИИ", reply, "bot");
  chatHistory.push({sender:"ИИ", text:reply, className:"bot"});
  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
}

// --- Чат с помощником ---
assistantSend.addEventListener("click", teachModel);
assistantInput.addEventListener("keydown", e => { if(e.key==="Enter") teachModel(); });

function teachModel() {
  const text = assistantInput.value.trim();
  if(!text) return;
  addMessage(assistantBox, "Вы (обучение)", text, "user");
  trainedPhrases.push(text);
  localStorage.setItem("trainedPhrases", JSON.stringify(trainedPhrases));
  assistantInput.value = "";
  addMessage(assistantBox, "Помощник", "Фраза добавлена для обучения", "bot");
}

// --- Генерация ответа (мини-GPT логика) ---
function generateResponse(userText){
  if(trainedPhrases.length>0){
    // ищем похожие слова и выбираем подходящие фразы
    const lower = userText.toLowerCase();
    const matches = trainedPhrases.filter(p=>p.toLowerCase().includes(lower.split(" ")[0]));
    if(matches.length>0) return matches[Math.floor(Math.random()*matches.length)];
    return trainedPhrases[Math.floor(Math.random()*trainedPhrases.length)];
  }
  return "Я ещё учусь, добавь фразы через помощника.";
}

// --- Добавление сообщений ---
function addMessage(box, sender, text, className){
  const div = document.createElement("div");
  div.className = `message ${className}`;
  div.innerHTML = `<strong>${sender}:</strong> ${text}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>
