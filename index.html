<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>3D Город с безопасным движением</title>
  <style>
    body { margin: 0; overflow: hidden; background: #87ceeb; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
  // === СЦЕНА ===
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // === СВЕТ ===
  scene.add(new THREE.AmbientLight(0x555555));
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(20, 30, 20);
  scene.add(light);

  // === ДОРОГИ ===
  function makeRoad(width, height, x, z) {
    const geom = new THREE.PlaneGeometry(width, height);
    const mat = new THREE.MeshPhongMaterial({ color: 0x333333 });
    const road = new THREE.Mesh(geom, mat);
    road.rotation.x = -Math.PI / 2;
    road.position.set(x, 0, z);
    scene.add(road);
  }
  makeRoad(20, 400, 0, 0);
  makeRoad(400, 20, 0, -100);

  // === ДОМА ===
  const houses = [];
  function makeHouse(x, z) {
    const h = Math.random()*6+6;
    const geom = new THREE.BoxGeometry(8, h, 8);
    const mat = new THREE.MeshPhongMaterial({ color: 0x8b4513 });
    const house = new THREE.Mesh(geom, mat);
    house.position.set(x, h/2, z);
    scene.add(house);
    houses.push(house);
  }
  for (let z=-200; z<200; z+=40){ makeHouse(-15,z); makeHouse(15,z);}
  for (let x=-200; x<200; x+=40){ makeHouse(x,-85); makeHouse(x,-115);}

  // === СОЗДАНИЕ МАШИНЫ ===
  function createCar(color=0xff0000){
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2,0.5,4), new THREE.MeshPhongMaterial({ color }));
    body.position.y=0.25; car.add(body);
    const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.5,0.5,2), new THREE.MeshPhongMaterial({ color:0x0000ff }));
    cabin.position.set(0,0.75,-0.5); car.add(cabin);
    const wheelGeom=new THREE.CylinderGeometry(0.4,0.4,0.3,16);
    const wheelMat=new THREE.MeshPhongMaterial({ color:0x000000 });
    function addWheel(x,z){let w=new THREE.Mesh(wheelGeom,wheelMat);w.rotation.z=Math.PI/2;w.position.set(x,0.2,z);car.add(w);}
    addWheel(-1,-1.5);addWheel(1,-1.5);addWheel(-1,1.5);addWheel(1,1.5);

    // стоп-сигналы
    const stopMat = new THREE.MeshPhongMaterial({ color:0x330000, emissive:0x000000 });
    const stopL = new THREE.Mesh(new THREE.SphereGeometry(0.2,8,8), stopMat.clone());
    stopL.position.set(-0.6,0.5,2);
    car.add(stopL);
    const stopR = stopL.clone(); stopR.position.x=0.6; car.add(stopR);
    car.lights = {stop:[stopL,stopR]};
    return car;
  }

  // === ИГРОК ===
  const player = createCar(0xff0000);
  player.position.set(0,0.2,0);
  scene.add(player);

  // === ТРАФИК ===
  const traffic = [];
  const waypoints = [
    new THREE.Vector3(0,0,-180),
    new THREE.Vector3(100,0,-100),
    new THREE.Vector3(0,0,100),
    new THREE.Vector3(-100,0,-100)
  ];
  for(let i=0;i<4;i++){
    const other = createCar(0x00ff00);
    other.position.copy(waypoints[i]);
    scene.add(other);
    traffic.push({
      obj: other,
      speed: 0.1,
      targetIndex: (i+1)%waypoints.length
    });
  }

  // === ПОЛИЦИЯ ===
  const police = createCar(0x0000ff);
  police.position.set(-10,0.2,20);
  scene.add(police);

  // === СВЕТОФОР ===
  const redLight = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshPhongMaterial({color:0xff0000}));
  redLight.position.set(-2,5.4,-99.5);
  scene.add(redLight);
  const greenLight = new THREE.Mesh(new THREE.SphereGeometry(0.3,16,16), new THREE.MeshPhongMaterial({color:0x00ff00}));
  greenLight.position.set(-2,4.6,-99.5);
  scene.add(greenLight);
  let green=true;
  setInterval(()=>{green=!green;},4000);

  // === УПРАВЛЕНИЕ ===
  let speed=0, rotationSpeed=0;
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowUp') speed=0.3;
    if(e.key==='ArrowDown') speed=-0.2;
    if(e.key==='ArrowLeft') rotationSpeed=0.05;
    if(e.key==='ArrowRight') rotationSpeed=-0.05;
  });
  document.addEventListener('keyup',e=>{
    if(['ArrowUp','ArrowDown'].includes(e.key)) speed=0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) rotationSpeed=0;
  });

  // === ПОМОЩНИКИ ===
  function checkCollision(obj1, obj2){
    const box1 = new THREE.Box3().setFromObject(obj1);
    const box2 = new THREE.Box3().setFromObject(obj2);
    return box1.intersectsBox(box2);
  }
  function distance(a,b){
    return a.position.distanceTo(b.position);
  }

  // === АНИМАЦИЯ ===
  function animate(){
    requestAnimationFrame(animate);

    // === Игрок ===
    const oldPos = player.position.clone();
    player.rotation.y+=rotationSpeed;
    player.position.x+=Math.sin(player.rotation.y)*speed;
    player.position.z+=Math.cos(player.rotation.y)*speed;

    // Проверка столкновений игрока
    let collided=false;
    for(let h of houses){ if(checkCollision(player,h)) collided=true; }
    for(let t of traffic){ if(checkCollision(player,t.obj)) collided=true; }
    if(checkCollision(player,police)) collided=true;
    if(collided) player.position.copy(oldPos);

    // стоп-сигналы игрока
    player.lights.stop.forEach(l=>{
      l.material.emissive.set(speed<0?0xff0000:0x000000);
    });

    // === Камера ===
    camera.position.x = player.position.x - Math.sin(player.rotation.y)*10;
    camera.position.z = player.position.z - Math.cos(player.rotation.y)*10;
    camera.position.y = 6;
    camera.lookAt(player.position);

    // === Трафик ===
    for(let i=0;i<traffic.length;i++){
      let car = traffic[i];
      const target = waypoints[car.targetIndex];
      let dir = new THREE.Vector3().subVectors(target, car.obj.position);
      let dist = dir.length();
      dir.normalize();

      // проверка дистанции до других машин
      let tooClose = false;
      for(let j=0;j<traffic.length;j++){
        if(i!==j){
          let other = traffic[j];
          if(distance(car.obj,other.obj)<5){
            tooClose = true;
          }
        }
      }
      // проверка на игрока
      if(distance(car.obj,player)<5) tooClose = true;

      if(!tooClose){
        car.obj.position.addScaledVector(dir, car.speed);
        car.obj.rotation.y = Math.atan2(dir.x, dir.z);
        car.obj.lights.stop.forEach(l=>l.material.emissive.set(0x000000));
      } else {
        car.obj.lights.stop.forEach(l=>l.material.emissive.set(0xff0000));
      }

      if(dist<1){ car.targetIndex = (car.targetIndex+1)%waypoints.length; }
    }

    // === Полиция ===
    let dx=player.position.x-police.position.x;
    let dz=player.position.z-police.position.z;
    let pdist=Math.sqrt(dx*dx+dz*dz);
    if(pdist>6){ // держит дистанцию
      police.position.x+=dx/pdist*0.08;
      police.position.z+=dz/pdist*0.08;
      police.rotation.y=Math.atan2(dx,dz);
      police.lights.stop.forEach(l=>l.material.emissive.set(0x000000));
    } else {
      police.lights.stop.forEach(l=>l.material.emissive.set(0xff0000));
    }

    // === Светофор ===
    redLight.material.color.set(green?0x330000:0xff0000);
    greenLight.material.color.set(green?0x00ff00:0x003300);

    renderer.render(scene,camera);
  }
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
</script>
</body>
</html>
